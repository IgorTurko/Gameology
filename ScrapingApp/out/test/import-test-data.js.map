{"version":3,"sources":["webpack:///webpack/bootstrap fa836a2560eb4ef027a7","webpack:///./server/extensions.ts","webpack:///./server-test/test-data/import-test-data.ts","webpack:///./server/data-access/db.ts","webpack:///external \"mongodb\"","webpack:///./server/config.ts","webpack:///external \"fs\"","webpack:///./server/services/web-shop/mongo-web-shop-storage.ts","webpack:///./server/services/web-shop/web-shop-service.ts","webpack:///./server/services/web-shop/web-shop-validator.ts","webpack:///external \"pojo-fluent-validator\"","webpack:///./server/services/utils.ts","webpack:///./server/services/products/mongo-product-storage.ts","webpack:///./server/services/products/product-service.ts","webpack:///external \"node-uuid\"","webpack:///./server/services/event-bus.ts","webpack:///external \"events\"","webpack:///./server/services/products/product-validator.ts","webpack:///./server-test/test-data/web-shops.ts","webpack:///./server-test/test-data/products.ts"],"names":[],"mappings":";AAAA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA,uBAAe;AACf;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;;AAGA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;;;;;;;;;;;;;;ACtCA;AACA;AACA;AACA,yDAAwD,YAAY,EAAE;AACtE;AACA;AACA;AACA;AACA;AACA,UAAS,IAAI;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAuB,iBAAiB;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wBAAuB,iBAAiB;AACxC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAqC;AACrC,8BAA6B,0BAA0B,EAAE,EAAE;AAC3D;;;;;;;ACrDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA,EAAC;AACD;AACA;AACA;AACA,EAAC;;;;;;;ACpDD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL,EAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAiC,kCAAkC,EAAE;AACrE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;AACD,+CAA8C,cAAc;AAC5D;;;;;;;AC9CA;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA,+CAA8C,cAAc;AAC5D;;;;;;;ACNA;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC,iBAAiB,GAAG,SAAS,EAAE,EAAE;AACjE,iCAAgC,oBAAoB,EAAE;AACtD;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC,gBAAgB,SAAS,GAAG,SAAS,EAAE,EAAE;AACzE,iCAAgC,0BAA0B,EAAE;AAC5D;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC;AAChC;AACA,UAAS;AACT;AACA;AACA;AACA,UAAS,EAAE,EAAE;AACb,gCAA+B,gBAAgB,EAAE;AACjD;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC;AAChC;AACA,UAAS;AACT;AACA,UAAS,EAAE,EAAE;AACb,gCAA+B,gBAAgB,EAAE;AACjD;AACA;AACA,EAAC;AACD,+CAA8C,cAAc;AAC5D;;;;;;;ACpDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAsC;AACtC;AACA,gCAA+B,8BAA8B,EAAE,EAAE,EAAE;AACnE;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gCAA+B,8BAA8B,EAAE;AAC/D;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA,EAAC;AACD,+CAA8C,cAAc;AAC5D;;;;;;;AC5CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sEAAqE,gCAAgC;AACrG,+BAA8B,oDAAoD;AAClF,yCAAwC,4BAA4B,EAAE,GAAG,2DAA2D;AACpI,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;AACD,+CAA8C,cAAc;AAC5D;;;;;;;ACrBA;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA,qBAAoB,uBAAuB;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT,MAAK;AACL;AACA;;;;;;;ACvBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC,iBAAiB,GAAG,SAAS,EAAE,EAAE;AACjE,iCAAgC,oBAAoB,EAAE;AACtD;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC,gBAAgB,SAAS,GAAG,SAAS,EAAE,EAAE;AACzE,iCAAgC,mBAAmB,EAAE;AACrD,iCAAgC,iBAAiB,EAAE;AACnD;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC,gBAAgB,eAAe,GAAG,SAAS,EAAE,EAAE;AAC/E,iCAAgC,mBAAmB,EAAE;AACrD,iCAAgC,iBAAiB,EAAE;AACnD;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC;AAChC;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA,UAAS,EAAE,EAAE;AACb,gCAA+B,gBAAgB,EAAE;AACjD;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC,qBAAqB,gBAAgB,EAAE,EAAE;AACzE,iCAAgC,aAAa,EAAE;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAgC;AAChC;AACA,UAAS;AACT,2BAA0B;AAC1B;AACA;AACA;AACA,UAAS;AACT;AACA,UAAS,EAAE,QAAQ,EAAE;AACrB,iCAAgC,6BAA6B,EAAE;AAC/D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS,IAAI;AACb;AACA;AACA,iCAAgC,qBAAqB,gBAAgB,GAAG,gBAAgB,EAAE,EAAE;AAC5F;AACA;AACA,EAAC;AACD,+CAA8C,cAAc;AAC5D;;;;;;;ACjGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb,oCAAmC,wDAAwD,EAAE;AAC7F;AACA;AACA;AACA,cAAa;AACb,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAqB;AACrB;AACA;AACA;AACA,sBAAqB;AACrB;AACA,oDAAmD,sCAAsC,EAAE;AAC3F;AACA;AACA;AACA;AACA;AACA;AACA,cAAa;AACb,oCAAmC,sCAAsC,EAAE;AAC3E,UAAS;AACT;AACA;AACA,EAAC;AACD,+CAA8C,cAAc;AAC5D;;;;;;;ACtGA;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;AACD;AACA;AACA;;;;;;;ACpBA;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,+DAA8D,yCAAyC;AACvG;AACA,4BAA2B,4CAA4C;AACvE,qCAAoC,wBAAwB,EAAE,GAAG,yCAAyC;AAC1G,uHAAsH,gFAAgF,EAAE,GAAG,4DAA4D;AACvQ,0CAAyC,iCAAiC,EAAE;AAC5E,0CAAyC;AACzC,yCAAwC,qBAAqB,EAAE;AAC/D,yCAAwC,qCAAqC,EAAE;AAC/E,6BAA4B,EAAE,GAAG,+DAA+D;AAChG,UAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA,EAAC;AACD,+CAA8C,cAAc;AAC5D;;;;;;;AC3BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iBAAgB;AAChB;AACA;AACA;AACA;AACA,iBAAgB;AAChB;AACA;AACA;AACA;AACA,iBAAgB;AAChB;AACA,SAAQ;AACR;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;AACA;AACA,kBAAiB;AACjB;AACA;AACA;;;;;;;AClIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAK;AACL","file":"import-test-data.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n/** WEBPACK FOOTER **\n ** webpack/bootstrap fa836a2560eb4ef027a7\n **/","/// <reference path=\"typings/index.d.ts\" />\r\nif (!Array.prototype.toHash) {\r\n    Array.prototype.toHash = function toHash(keySelector, valueSelector) {\r\n        valueSelector = valueSelector || (function (e) { return (e); });\r\n        return this.reduce(function (hash, elem) {\r\n            var key = keySelector(elem);\r\n            var value = valueSelector(elem);\r\n            hash[key] = value;\r\n            return hash;\r\n        }, {});\r\n    };\r\n}\r\nif (!Array.prototype.min) {\r\n    Array.prototype.min = function min(selector) {\r\n        var self = this;\r\n        if (!self.length) {\r\n            return null;\r\n        }\r\n        var minElement = self[0];\r\n        var minValue = selector(minElement);\r\n        for (var i = 1; i < self.length; i++) {\r\n            var element = self[i];\r\n            var value = selector(element);\r\n            if (value < minValue) {\r\n                minValue = value;\r\n                minElement = element;\r\n            }\r\n        }\r\n        return minElement;\r\n    };\r\n}\r\nif (!Array.prototype.max) {\r\n    Array.prototype.max = function min(selector) {\r\n        var self = this;\r\n        if (!self.length) {\r\n            return null;\r\n        }\r\n        var maxElement = self[0];\r\n        var maxValue = selector(maxElement);\r\n        for (var i = 1; i < self.length; i++) {\r\n            var element = self[i];\r\n            var value = selector(element);\r\n            if (value > maxValue) {\r\n                maxValue = value;\r\n                maxElement = element;\r\n            }\r\n        }\r\n        return maxElement;\r\n    };\r\n}\r\nif (!Object.entries) {\r\n    Object.entries = function (obj) { return Object.keys(obj)\r\n        .map(function (key) { return ([key, obj[key]]); }); };\r\n}\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/extensions.ts\n ** module id = 1\n ** module chunks = 0 1\n **/","/// <reference path=\"../../server/typings/index.d.ts\" />\r\n\"use strict\";\r\nvar db_1 = require(\"../../server/data-access/db\");\r\nvar mongo_web_shop_storage_1 = require(\"../../server/services/web-shop/mongo-web-shop-storage\");\r\nvar web_shop_service_1 = require(\"../../server/services/web-shop/web-shop-service\");\r\nvar mongo_product_storage_1 = require(\"../../server/services/products/mongo-product-storage\");\r\nvar product_service_1 = require(\"../../server/services/products/product-service\");\r\nvar web_shops_1 = require(\"./web-shops\");\r\nvar products_1 = require(\"./products\");\r\nvar db = new db_1.default();\r\nvar webShopService = new web_shop_service_1.default(new mongo_web_shop_storage_1.default(db));\r\nvar productService = new product_service_1.default(new mongo_product_storage_1.default(db));\r\nfunction addWebShop(webShop) {\r\n    return webShopService.put(webShop)\r\n        .then(function (res) {\r\n        if (res[\"isValid\"] === undefined) {\r\n            var index = web_shops_1.webShops.indexOf(webShop);\r\n            if (index !== web_shops_1.webShops.length - 1) {\r\n                return addWebShop(web_shops_1.webShops[index + 1]);\r\n            }\r\n        }\r\n        else {\r\n            console.error(\"Error adding web shop \" + webShop.title);\r\n            console.dir(res);\r\n        }\r\n    })\r\n        .catch(function (err) {\r\n        console.error(\"Error adding web shop \" + webShop.title);\r\n        console.error(err);\r\n    });\r\n}\r\nfunction addProduct(product) {\r\n    return productService.save(product)\r\n        .then(function () {\r\n        console.info(\"Product \" + product.title + \" added.\");\r\n        var index = products_1.products.indexOf(product);\r\n        if (index !== products_1.products.length - 1) {\r\n            return addProduct(products_1.products[index + 1]);\r\n        }\r\n    })\r\n        .catch(function (err) {\r\n        console.error(\"Error adding product \" + product.title);\r\n        console.error(err);\r\n    });\r\n}\r\naddWebShop(web_shops_1.webShops[0])\r\n    .then(function () {\r\n    return addProduct(products_1.products[0]);\r\n})\r\n    .then(function () {\r\n    console.info(\"Test data added.\");\r\n    process.exit();\r\n});\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server-test/test-data/import-test-data.ts\n ** module id = 2\n ** module chunks = 0\n **/","\"use strict\";\r\n/// <reference path=\"../typings/index.d.ts\" />\r\nvar mongo = require(\"mongodb\");\r\nvar config_1 = require(\"../config\");\r\nvar connectionString = config_1.default.mongoUrl;\r\nvar db = new Promise(function (resolve, reject) {\r\n    if (process.env.OPENSHIFT_MONGODB_DB_PASSWORD) {\r\n        connectionString = process.env.OPENSHIFT_MONGODB_DB_USERNAME + \":\" +\r\n            process.env.OPENSHIFT_MONGODB_DB_PASSWORD + \"@\" +\r\n            process.env.OPENSHIFT_MONGODB_DB_HOST + ':' +\r\n            process.env.OPENSHIFT_MONGODB_DB_PORT + '/' +\r\n            process.env.OPENSHIFT_APP_NAME;\r\n    }\r\n    mongo.MongoClient.connect('mongodb://' + connectionString, function (err, db) {\r\n        if (err) {\r\n            reject(err);\r\n        }\r\n        else {\r\n            console.info(\"Connected to Mongo server at \" + connectionString);\r\n            resolve(db);\r\n        }\r\n    });\r\n});\r\nvar Database = (function () {\r\n    function Database() {\r\n    }\r\n    Database.prototype.collection = function (collection) {\r\n        if (!collection)\r\n            throw new Error(\"collection is undefined\");\r\n        if (!Database.Collections[collection])\r\n            throw new Error(\"Collection \" + collection + \" is unknown\");\r\n        return this.connect()\r\n            .then(function (db) { return db.collection(collection); });\r\n    };\r\n    Database.prototype.connect = function () {\r\n        return db;\r\n    };\r\n    Database.Collections = {\r\n        sessions: \"sessions\",\r\n        webshops: \"webshops\",\r\n        products: \"products\",\r\n        users: \"users\"\r\n    };\r\n    return Database;\r\n}());\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.default = Database;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/data-access/db.ts\n ** module id = 3\n ** module chunks = 0 1\n **/","module.exports = require(\"mongodb\");\n\n\n/*****************\n ** WEBPACK FOOTER\n ** external \"mongodb\"\n ** module id = 4\n ** module chunks = 0 1\n **/","\"use strict\";\r\n/// <reference path=\"typings/index.d.ts\"/>\r\nvar fs = require(\"fs\");\r\nvar configContent = fs.readFileSync(\"./config.json\", \"utf8\");\r\nvar configuration = JSON.parse(configContent);\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.default = configuration;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/config.ts\n ** module id = 5\n ** module chunks = 0 1\n **/","module.exports = require(\"fs\");\n\n\n/*****************\n ** WEBPACK FOOTER\n ** external \"fs\"\n ** module id = 6\n ** module chunks = 0 1\n **/","/// <reference path=\"../../typings/index.d.ts\" />\r\n\"use strict\";\r\nvar db_1 = require(\"../../data-access/db\");\r\nvar MongoWebShopStorage = (function () {\r\n    function MongoWebShopStorage(db) {\r\n        this.db = db;\r\n        if (!db)\r\n            throw new Error(\"db is undefined\");\r\n    }\r\n    MongoWebShopStorage.prototype.all = function () {\r\n        return this.db\r\n            .collection(db_1.default.Collections.webshops)\r\n            .then(function (c) { return c.find({}, { _id: 0 }); })\r\n            .then(function (c) { return c.toArray(); });\r\n    };\r\n    MongoWebShopStorage.prototype.one = function (id) {\r\n        if (!id)\r\n            throw new Error(\"id is undefined\");\r\n        return this.db\r\n            .collection(db_1.default.Collections.webshops)\r\n            .then(function (c) { return c.find({ id: id }, { _id: 0 }); })\r\n            .then(function (c) { return c.limit(1).next(); });\r\n    };\r\n    MongoWebShopStorage.prototype.save = function (webShop) {\r\n        if (!webShop)\r\n            throw new Error(\"webShop is undefined\");\r\n        return this.db\r\n            .collection(db_1.default.Collections.webshops)\r\n            .then(function (c) { return c.updateOne({\r\n            id: webShop.id\r\n        }, {\r\n            $set: {\r\n                deliveryPrice: webShop.deliveryPrice\r\n            }\r\n        }); })\r\n            .then(function () { return webShop; });\r\n    };\r\n    MongoWebShopStorage.prototype.put = function (webShop) {\r\n        if (!webShop)\r\n            throw new Error(\"webShop is undefined\");\r\n        return this.db\r\n            .collection(db_1.default.Collections.webshops)\r\n            .then(function (c) { return c.updateOne({\r\n            id: webShop.id\r\n        }, webShop, {\r\n            upsert: true\r\n        }); })\r\n            .then(function () { return webShop; });\r\n    };\r\n    return MongoWebShopStorage;\r\n}());\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.default = MongoWebShopStorage;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/services/web-shop/mongo-web-shop-storage.ts\n ** module id = 7\n ** module chunks = 0 1\n **/","/// <reference path=\"../../typings/index.d.ts\" />\r\n\"use strict\";\r\nvar web_shop_validator_1 = require(\"./web-shop-validator\");\r\nvar WebShopService = (function () {\r\n    function WebShopService(storage) {\r\n        this.storage = storage;\r\n        this.validator = new web_shop_validator_1.default();\r\n        if (!storage)\r\n            throw new Error(\"storage is undefined\");\r\n    }\r\n    WebShopService.prototype.all = function () {\r\n        return this.storage.all();\r\n    };\r\n    WebShopService.prototype.one = function (webShopId) {\r\n        if (!webShopId)\r\n            throw new Error(\"webShopId is undefined\");\r\n        return this.storage.one(webShopId);\r\n    };\r\n    WebShopService.prototype.save = function (webShop) {\r\n        var _this = this;\r\n        if (!webShop)\r\n            throw new Error(\"webShop is undefined\");\r\n        return this.validator\r\n            .validate(webShop)\r\n            .then(function (webShop) { return _this.storage\r\n            .save(webShop)\r\n            .then(function () { return _this.one(webShop.id); }); });\r\n    };\r\n    WebShopService.prototype.put = function (webShop) {\r\n        var _this = this;\r\n        if (!webShop)\r\n            throw new Error(\"webShop is undefined\");\r\n        return this.storage\r\n            .put(webShop)\r\n            .then(function () { return _this.one(webShop.id); })\r\n            .catch(function (err) {\r\n            throw {\r\n                \"\": \"\" + err\r\n            };\r\n        });\r\n    };\r\n    return WebShopService;\r\n}());\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.default = WebShopService;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/services/web-shop/web-shop-service.ts\n ** module id = 8\n ** module chunks = 0 1\n **/","/// <reference path=\"../../typings/index.d.ts\" />\r\n\"use strict\";\r\nvar pojo_fluent_validator_1 = require(\"pojo-fluent-validator\");\r\nvar utils_1 = require(\"../utils\");\r\nvar WebShopValidator = (function () {\r\n    function WebShopValidator() {\r\n        /** Only updateable fields is validated */\r\n        this.validator = pojo_fluent_validator_1.rules.obj({\r\n            deliveryPrice: pojo_fluent_validator_1.rules.num(false, { errorMessage: \"Invalid price\" })\r\n                .parseNumber({ errorMessage: \"Price is not recognized as number\" })\r\n                .must(function (price) { return !price || price > 0; }, { errorMessage: \"Delivery price must be greater than zero\" })\r\n        }).expandable();\r\n    }\r\n    WebShopValidator.prototype.validate = function (webShop) {\r\n        if (!webShop)\r\n            throw new Error(\"webShop is undefined\");\r\n        return utils_1.validate(webShop, this.validator);\r\n    };\r\n    return WebShopValidator;\r\n}());\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.default = WebShopValidator;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/services/web-shop/web-shop-validator.ts\n ** module id = 9\n ** module chunks = 0 1\n **/","module.exports = require(\"pojo-fluent-validator\");\n\n\n/*****************\n ** WEBPACK FOOTER\n ** external \"pojo-fluent-validator\"\n ** module id = 10\n ** module chunks = 0 1\n **/","/// <reference path=\"../typings/index.d.ts\" />\r\n\"use strict\";\r\nvar pojo_fluent_validator_1 = require(\"pojo-fluent-validator\");\r\nfunction validate(value) {\r\n    var validators = [];\r\n    for (var _i = 1; _i < arguments.length; _i++) {\r\n        validators[_i - 1] = arguments[_i];\r\n    }\r\n    if (!validators || !validators.length) {\r\n        throw new Error(\"At least one validator is required\");\r\n    }\r\n    return new Promise(function (resolve, reject) {\r\n        pojo_fluent_validator_1.validate.apply(void 0, [value, function (errors, result) {\r\n            if (errors) {\r\n                reject(errors);\r\n            }\r\n            else {\r\n                resolve(result);\r\n            }\r\n            ;\r\n        }].concat(validators));\r\n    });\r\n}\r\nexports.validate = validate;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/services/utils.ts\n ** module id = 11\n ** module chunks = 0 1\n **/","/// <reference path=\"../../typings/index.d.ts\" />\r\n\"use strict\";\r\nvar db_1 = require(\"../../data-access/db\");\r\nvar MongoProductStorage = (function () {\r\n    function MongoProductStorage(db) {\r\n        this.db = db;\r\n        if (!db)\r\n            throw new Error(\"db is missing\");\r\n    }\r\n    MongoProductStorage.prototype.all = function () {\r\n        return this.db\r\n            .collection(db_1.default.Collections.products)\r\n            .then(function (c) { return c.find({}, { _id: 0 }); })\r\n            .then(function (c) { return c.toArray(); });\r\n    };\r\n    MongoProductStorage.prototype.one = function (id) {\r\n        if (!id)\r\n            throw new Error(\"id is undefined\");\r\n        return this.db\r\n            .collection(db_1.default.Collections.products)\r\n            .then(function (c) { return c.find({ id: id }, { _id: 0 }); })\r\n            .then(function (c) { return c.limit(1); })\r\n            .then(function (c) { return c.next(); });\r\n    };\r\n    MongoProductStorage.prototype.findByTitle = function (title) {\r\n        if (!title)\r\n            return Promise.reject(\"Title is empty\");\r\n        return this.db\r\n            .collection(db_1.default.Collections.products)\r\n            .then(function (c) { return c.find({ title: title }, { _id: 0 }); })\r\n            .then(function (c) { return c.limit(1); })\r\n            .then(function (c) { return c.next(); });\r\n    };\r\n    MongoProductStorage.prototype.save = function (product) {\r\n        if (!product)\r\n            throw new Error(\"product is undefined\");\r\n        return this.db\r\n            .collection(db_1.default.Collections.products)\r\n            .then(function (c) { return c.updateOne({\r\n            id: product.id\r\n        }, {\r\n            $set: {\r\n                id: product.id,\r\n                title: product.title,\r\n                scrapingUrls: product.scrapingUrls\r\n            }\r\n        }, {\r\n            upsert: true\r\n        }); })\r\n            .then(function () { return product; });\r\n    };\r\n    MongoProductStorage.prototype.delete = function (productId) {\r\n        if (!productId)\r\n            throw new Error(\"Product ID is not defined.\");\r\n        return this.db\r\n            .collection(db_1.default.Collections.products)\r\n            .then(function (c) { return c.deleteOne({ id: productId }); })\r\n            .then(function (c) { return true; });\r\n    };\r\n    MongoProductStorage.prototype.setScrapingData = function (productId, webShopId, values) {\r\n        var _this = this;\r\n        if (!productId)\r\n            throw new Error(\"productId is undefined\");\r\n        if (!webShopId)\r\n            throw new Error(\"webShopId is undefined\");\r\n        if (!values)\r\n            throw new Error(\"values is undefined\");\r\n        return this.db\r\n            .collection(db_1.default.Collections.products)\r\n            .then(function (c) { return c.updateOne({\r\n            id: productId\r\n        }, {\r\n            $set: (_a = {},\r\n                _a[\"values.\" + webShopId] = values,\r\n                _a\r\n            )\r\n        }, {\r\n            upsert: true\r\n        }); var _a; })\r\n            .then(function (r) { return _this.one(productId); });\r\n    };\r\n    MongoProductStorage.prototype.discardScrapingData = function (productId, shops) {\r\n        if (!shops || !shops.length) {\r\n            return;\r\n        }\r\n        var unset = shops.reduce(function (val, shopId) {\r\n            val[(\"log.\" + shopId)] = \"\";\r\n            val[(\"values.\" + shopId)] = \"\";\r\n            return val;\r\n        }, {});\r\n        return this.db\r\n            .collection(db_1.default.Collections.products)\r\n            .then(function (c) { return c.updateOne({ id: productId }, { $unset: unset }); });\r\n    };\r\n    return MongoProductStorage;\r\n}());\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.default = MongoProductStorage;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/services/products/mongo-product-storage.ts\n ** module id = 12\n ** module chunks = 0 1\n **/","/// <reference path=\"../../typings/index.d.ts\" />\r\n\"use strict\";\r\nvar uuid = require(\"node-uuid\");\r\nvar event_bus_1 = require(\"../event-bus\");\r\nvar product_validator_1 = require(\"./product-validator\");\r\nvar ProductService = (function () {\r\n    function ProductService(storage) {\r\n        this.storage = storage;\r\n        this.validator = new product_validator_1.default();\r\n        if (!storage)\r\n            throw new Error(\"storage is undefined\");\r\n    }\r\n    ProductService.prototype.all = function () {\r\n        return this.storage.all();\r\n    };\r\n    ProductService.prototype.save = function (product) {\r\n        var _this = this;\r\n        if (!product)\r\n            throw new Error(\"product is undefined\");\r\n        if (!product.id)\r\n            product.id = uuid.v1();\r\n        return this.validator\r\n            .validate(product)\r\n            .then(function (product) {\r\n            return _this.storage\r\n                .findByTitle(product.title)\r\n                .then(function (found) {\r\n                if (found && found.id !== product.id) {\r\n                    throw {\r\n                        \"title\": [\"Product with such title already exists\"]\r\n                    };\r\n                }\r\n            })\r\n                .then(function () { return _this.writeProductAndDiscardScrapeData(product); })\r\n                .then(function (product) {\r\n                event_bus_1.eventBus.emit(event_bus_1.EventNames.ProductUpdated, product.id);\r\n                return product;\r\n            });\r\n        });\r\n    };\r\n    ProductService.prototype.one = function (productId) {\r\n        if (!productId)\r\n            throw new Error(\"productId is undefined\");\r\n        return this.storage.one(productId);\r\n    };\r\n    ProductService.prototype.findByTitle = function (title) {\r\n        return this.storage.findByTitle(title);\r\n    };\r\n    ProductService.prototype.updateScrapedData = function (productId, webshopId, data) {\r\n        var _this = this;\r\n        if (!productId)\r\n            throw new Error(\"productId is undefined\");\r\n        if (!webshopId)\r\n            throw new Error(\"webShopId is undefined\");\r\n        if (!data)\r\n            throw new Error(\"data is undefined\");\r\n        return this.one(productId)\r\n            .then(function (product) {\r\n            return _this.storage.setScrapingData(product.id, webshopId, data);\r\n        });\r\n    };\r\n    ProductService.prototype.delete = function (productId) {\r\n        if (!productId)\r\n            throw new Error(\"Product ID is not defined.\");\r\n        return this.storage.delete(productId);\r\n    };\r\n    /**\r\n     * Writes validated product to storage and removes values and logs for changed URL.\r\n     */\r\n    ProductService.prototype.writeProductAndDiscardScrapeData = function (product) {\r\n        var _this = this;\r\n        return this.one(product.id)\r\n            .then(function (origin) {\r\n            return _this.storage\r\n                .save(product)\r\n                .then(function () {\r\n                if (origin) {\r\n                    var shops = Object.entries(product.scrapingUrls)\r\n                        .filter(function (_a) {\r\n                        var shop = _a[0], url = _a[1];\r\n                        var originUrl = origin.scrapingUrls[shop];\r\n                        return url !== originUrl;\r\n                    })\r\n                        .map(function (_a) {\r\n                        var shop = _a[0], url = _a[1];\r\n                        return shop;\r\n                    });\r\n                    var removedShops = Object.keys(origin.scrapingUrls)\r\n                        .filter(function (shopId) { return !product.scrapingUrls[shopId]; });\r\n                    shops.push.apply(shops, removedShops);\r\n                    return _this.storage.discardScrapingData(product.id, shops);\r\n                }\r\n                else {\r\n                    return Promise.resolve();\r\n                }\r\n            })\r\n                .then(function () { return _this.storage.one(product.id); });\r\n        });\r\n    };\r\n    return ProductService;\r\n}());\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.default = ProductService;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/services/products/product-service.ts\n ** module id = 13\n ** module chunks = 0 1\n **/","module.exports = require(\"node-uuid\");\n\n\n/*****************\n ** WEBPACK FOOTER\n ** external \"node-uuid\"\n ** module id = 14\n ** module chunks = 0 1\n **/","/// <reference path=\"../typings/index.d.ts\"/>\r\n\"use strict\";\r\nvar events_1 = require(\"events\");\r\nvar EventNames = (function () {\r\n    function EventNames() {\r\n    }\r\n    /**\r\n     * Published when product inserted or updated.\r\n     * Params is product id: string.\r\n     */\r\n    EventNames.ProductUpdated = \"product-updated\";\r\n    /**\r\n     * Published when product data is scraped.\r\n     * Param is product id: string.\r\n     */\r\n    EventNames.ProductScraped = \"product-scraped\";\r\n    return EventNames;\r\n}());\r\nexports.EventNames = EventNames;\r\nvar eventBus = new events_1.EventEmitter();\r\nexports.eventBus = eventBus;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/services/event-bus.ts\n ** module id = 15\n ** module chunks = 0 1\n **/","module.exports = require(\"events\");\n\n\n/*****************\n ** WEBPACK FOOTER\n ** external \"events\"\n ** module id = 16\n ** module chunks = 0 1\n **/","/// <reference path=\"../../typings/index.d.ts\" />\r\n\"use strict\";\r\nvar pojo_fluent_validator_1 = require(\"pojo-fluent-validator\");\r\nvar utils_1 = require(\"../utils\");\r\nvar ProductValidator = (function () {\r\n    function ProductValidator() {\r\n        this.validator = pojo_fluent_validator_1.rules.obj({\r\n            id: pojo_fluent_validator_1.rules.str().notEmpty({ errorMessage: \"Product ID is required\" }),\r\n            title: pojo_fluent_validator_1.rules.str()\r\n                .notEmpty({ errorMessage: \"Product title is required\" })\r\n                .must(function (t) { return t.length < 1024; }, { errorMessage: \"Product title too long\" }),\r\n            scrapingUrls: pojo_fluent_validator_1.rules.hash(pojo_fluent_validator_1.rules.str().must(function (url) { return !url || (url.indexOf(\"http://\") === 0 || url.indexOf(\"https://\") === 0); }, { errorMessage: \"URL must starts from http:// or https:// \" }))\r\n                .filter(function (k, v) { return v && v.trim().length > 0; })\r\n                .before(function (urls) { return Object.keys(urls)\r\n                .map(function (shopId) { return urls[shopId]; })\r\n                .filter(function (url) { return url && url.trim().length > 0; })\r\n                .length > 0; }, { errorMessage: \"At least one scraping URL must be specified.\" })\r\n        });\r\n    }\r\n    ProductValidator.prototype.validate = function (product) {\r\n        if (!product)\r\n            throw new Error(\"product is undefined\");\r\n        return utils_1.validate(product, this.validator);\r\n    };\r\n    return ProductValidator;\r\n}());\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.default = ProductValidator;\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server/services/products/product-validator.ts\n ** module id = 17\n ** module chunks = 0 1\n **/","/// <reference path=\"../../server/typings/index.d.ts\" />\r\n\"use strict\";\r\nexports.webShops = [\r\n    {\r\n        id: \"gameology\",\r\n        isBase: true,\r\n        title: \"Gameology\",\r\n        scrapingSettings: {\r\n            title: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"h1[itemprop='name']\"\r\n                }],\r\n            price: [{\r\n                    type: \"number\",\r\n                    elementSelector: \"meta[property='og:price:amount']\",\r\n                    attribute: \"content\"\r\n                }],\r\n            image: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"#ProductPhotoImg\",\r\n                    attribute: \"src\"\r\n                }]\r\n        }\r\n    },\r\n    {\r\n        id: \"spieledeluxe\",\r\n        isBase: false,\r\n        title: \"Spiele-Deluxe\",\r\n        scrapingSettings: {\r\n            title: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"h1[itemprop='name']\"\r\n                }],\r\n            price: [{\r\n                    type: \"number\",\r\n                    elementSelector: \"span[itemprop='price']\",\r\n                    attribute: \"content\"\r\n                }],\r\n            image: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"img[itemprop='image']\",\r\n                    attribute: \"src\"\r\n                }]\r\n        }\r\n    },\r\n    {\r\n        id: \"joedodgy\",\r\n        isBase: false,\r\n        title: \"Joe Dodgy\",\r\n        scrapingSettings: {\r\n            title: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"meta[itemprop='name']\",\r\n                    attribute: \"content\"\r\n                }],\r\n            price: [{\r\n                    type: \"number\",\r\n                    elementSelector: \"#productPrices\"\r\n                }],\r\n            image: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"meta[itemprop='image']\",\r\n                    attribute: \"content\"\r\n                }]\r\n        }\r\n    },\r\n    {\r\n        id: \"mightyape\",\r\n        isBase: false,\r\n        title: \"Mighty Ape\",\r\n        scrapingSettings: {\r\n            title: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"meta[property='og:title']\",\r\n                    attribute: \"content\"\r\n                }],\r\n            price: [{\r\n                    type: \"number\",\r\n                    extract: \"regex\",\r\n                    regex: \"for \\\\$([\\\\d.]*) at\"\r\n                }],\r\n            image: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"meta[property='og:image']\",\r\n                    attribute: \"content\"\r\n                }]\r\n        }\r\n    },\r\n    // {\r\n    //     id: \"unhalfbricking\",\r\n    //     title: \"Unhalfbricking\",\r\n    //     isBase: false,\r\n    //     scrapingSettings: {\r\n    //         title: [{\r\n    //             type: \"string\",\r\n    //             extract: \"regex\",\r\n    //             regex: \"<font.*?>(.*?)<\\\\/font>\"\r\n    //         }],\r\n    //         price: [{\r\n    //             type: \"number\",\r\n    //             extract: \"regex\",\r\n    //             regex: \"\\\\(\\\\$([\\\\d\\\\.]*?)\\\\)\"\r\n    //         }],\r\n    //         image: [{\r\n    //             type: \"relativeUrl\",\r\n    //             extract: \"regex\",\r\n    //             regex: '<img.*?src=\"(.*?images/games/.*?)\".*?\\\\>'\r\n    //         }]\r\n    //     }\r\n    // },\r\n    {\r\n        id: \"dungeoncrawl\",\r\n        title: \"Dungeon Crawl\",\r\n        isBase: false,\r\n        scrapingSettings: {\r\n            title: [{\r\n                    type: \"string\",\r\n                    elementSelector: \"h1[itemprop='name']\"\r\n                }],\r\n            price: [{\r\n                    type: \"number\",\r\n                    elementSelector: \"div.productprice.productpricetext[itemprop='price']\"\r\n                }],\r\n            image: [{\r\n                    type: \"relativeUrl\",\r\n                    elementSelector: \"meta[property='og:image'][content*='/assets/full']\",\r\n                    attribute: \"content\"\r\n                }]\r\n        }\r\n    }\r\n];\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server-test/test-data/web-shops.ts\n ** module id = 18\n ** module chunks = 0\n **/","/// <reference path=\"../../server/typings/index.d.ts\" />\r\n\"use strict\";\r\nexports.products = [\r\n    {\r\n        id: \"be81468f1c774f4c96e11d3e2c2df67e\",\r\n        title: \"DIXIT\",\r\n        scrapingUrls: {\r\n            \"gameology\": \"http://www.gameology.com.au/products/b157_dixit_b?variant=11511240901\",\r\n            \"spieledeluxe\": \"http://spieledeluxe.com/products/dixit-2014-edition\",\r\n            \"joedodgy\": \"http://www.joedodgy.com.au/index.php?main_page=product_info&cPath=3_373_374&products_id=1038\",\r\n            \"mightyape\": \"https://www.mightyape.com.au/product/Dixit/10339571\",\r\n            \"dungeoncrawl\": \"http://www.dungeoncrawl.com.au/dixit\"\r\n        }\r\n    },\r\n    {\r\n        id: \"43e5dc04389047c580079af28cd03dc4\",\r\n        title: \"King of Tokyo\",\r\n        scrapingUrls: {\r\n            \"gameology\": \"http://www.gameology.com.au/products/b147_kingtok_b?variant=11511228037\",\r\n            \"spieledeluxe\": \"http://spieledeluxe.com/products/king-of-tokyo\",\r\n            \"joedodgy\": \"http://www.joedodgy.com.au/index.php?main_page=product_info&cPath=3_438_439&products_id=1092\",\r\n            \"mightyape\": \"https://www.mightyape.com.au/product/King-of-New-York/22831407\",\r\n            \"dungeoncrawl\": \"http://www.dungeoncrawl.com.au/king-of-tokyo\"\r\n        }\r\n    },\r\n    {\r\n        id: \"893ce29ee2414a8fa9378a633c3909d5\",\r\n        title: \"Talisman\",\r\n        scrapingUrls: {\r\n            \"gameology\": \"http://www.gameology.com.au/products/b175_talisman_b?variant=11511245893\",\r\n            \"spieledeluxe\": \"http://spieledeluxe.com/products/talisman-revised-4th-edition\",\r\n            \"joedodgy\": \"http://www.joedodgy.com.au/index.php?main_page=product_info&cPath=3_28_66&products_id=49\",\r\n            \"mightyape\": \"https://www.mightyape.com.au/product/Talisman-4th-edition/10515428\",\r\n            \"dungeoncrawl\": \"http://www.dungeoncrawl.com.au/talisman-revised-4th-edition\"\r\n        }\r\n    },\r\n    {\r\n        id: \"0cdd314016294b369c48c10694928a46\",\r\n        title: \"Takenoko\",\r\n        scrapingUrls: {\r\n            \"gameology\": \"http://www.gameology.com.au/products/b174_takenoko_b?variant=11511245125\",\r\n            \"spieledeluxe\": \"http://spieledeluxe.com/products/takenoko-1\",\r\n            \"joedodgy\": \"http://www.joedodgy.com.au/index.php?main_page=product_info&cPath=3_373_376&products_id=1533\",\r\n            \"mightyape\": \"https://www.mightyape.com.au/product/Takenoko/19756515\",\r\n            \"dungeoncrawl\": \"http://www.dungeoncrawl.com.au/takenoko\"\r\n        }\r\n    },\r\n    {\r\n        id: \"b0c45cf6a00e4ec493b2300d12be6a84\",\r\n        title: \"Tokaido\",\r\n        scrapingUrls: {\r\n            \"gameology\": \"http://www.gameology.com.au/products/tokaido?variant=16810693829\",\r\n            \"spieledeluxe\": \"http://spieledeluxe.com/products/tokaido\",\r\n            \"joedodgy\": \"http://www.joedodgy.com.au/index.php?main_page=product_info&cPath=3_276&products_id=1644\",\r\n            \"mightyape\": \"https://www.mightyape.com.au/product/Tokaido/21890321\",\r\n            \"dungeoncrawl\": \"http://www.dungeoncrawl.com.au/tokaido\"\r\n        }\r\n    },\r\n];\r\n\n\n\n/*****************\n ** WEBPACK FOOTER\n ** ./server-test/test-data/products.ts\n ** module id = 19\n ** module chunks = 0\n **/"],"sourceRoot":""}